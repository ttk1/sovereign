<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sovereign</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242836;
    --border: #2e3345;
    --text: #e4e6f0;
    --text-dim: #8b90a5;
    --accent: #6c8cff;
    --accent-glow: rgba(108, 140, 255, 0.3);
    --sigil: #fbbf24;
    --green: #34d399;
    --red: #f87171;
    --treasure-bg: #2a2520;
    --victory-bg: #1a2a1a;
    --action-bg: #1a1a2a;
    --radius: 10px;
    --card-w: clamp(145px, 8.5vw, 220px);
    --card-h: clamp(210px, 12.5vw, 330px);
  }

  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    font-size: 20px;
  }

  /* â”€â”€ Lobby â”€â”€ */
  #lobby {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 2rem;
  }

  .lobby-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2.5rem;
    max-width: 480px;
    width: 100%;
  }

  .lobby-card h1 {
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 0.4rem;
    background: linear-gradient(135deg, var(--accent), #a78bfa);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .lobby-card .subtitle {
    color: var(--text-dim);
    font-size: 0.85rem;
    margin-bottom: 2rem;
  }

  .form-group { margin-bottom: 1.2rem; }

  .form-group label {
    display: block;
    font-size: 0.8rem;
    color: var(--text-dim);
    margin-bottom: 0.4rem;
    font-weight: 600;
  }

  .form-group input {
    width: 100%;
    padding: 0.7rem 1rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-size: 0.95rem;
    font-family: inherit;
    outline: none;
    transition: border-color 0.2s;
  }

  .form-group input:focus { border-color: var(--accent); }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    padding: 0.7rem 1.4rem;
    border: none;
    border-radius: var(--radius);
    font-family: inherit;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
  }
  .btn-primary:hover { filter: brightness(1.15); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { background: var(--border); }

  .btn-small {
    padding: 0.4rem 0.8rem;
    font-size: 0.78rem;
  }

  .btn-sigil { background: var(--sigil); color: #000; }
  .btn-sigil:hover { filter: brightness(1.1); }

  .btn-red { background: var(--red); color: #000; }

  .btn-row { display: flex; gap: 0.6rem; margin-top: 1rem; }

  .room-list {
    margin-top: 1.5rem;
    border-top: 1px solid var(--border);
    padding-top: 1rem;
  }

  .room-list h3 {
    font-size: 0.85rem;
    color: var(--text-dim);
    margin-bottom: 0.6rem;
  }

  .room-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.6rem 0.8rem;
    background: var(--surface2);
    border-radius: var(--radius);
    margin-bottom: 0.4rem;
    font-size: 0.85rem;
  }

  .room-item .room-id {
    font-family: 'JetBrains Mono', monospace;
    color: var(--accent);
  }

  /* â”€â”€ Waiting Room â”€â”€ */
  #waiting {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 2rem;
  }

  .waiting-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2.5rem;
    max-width: 500px;
    width: 100%;
    text-align: center;
  }

  .waiting-card h2 {
    font-size: 1.3rem;
    margin-bottom: 0.3rem;
  }

  .waiting-card .room-code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.6rem;
    color: var(--accent);
    margin: 1rem 0;
    letter-spacing: 0.15em;
    user-select: all;
  }

  .player-list {
    list-style: none;
    margin: 1.5rem 0;
  }

  .player-list li {
    padding: 0.5rem;
    background: var(--surface2);
    border-radius: var(--radius);
    margin-bottom: 0.3rem;
    font-size: 0.9rem;
  }

  /* â”€â”€ Game Board â”€â”€ */
  #game {
    display: none;
    min-height: 100vh;
    padding: 0.8rem;
    max-width: 2700px;
    margin: 0 auto;
  }

  .game-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.6rem 1rem;
    background: var(--surface);
    border-radius: var(--radius);
    margin-bottom: 0.8rem;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .turn-info {
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.8rem;
  }

  .turn-info .phase-badge {
    padding: 0.25rem 0.7rem;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 600;
    background: var(--accent);
    color: #fff;
  }

  .status-bar {
    display: flex;
    gap: 1rem;
    font-size: 1rem;
    font-family: 'JetBrains Mono', monospace;
  }

  .status-item { display: flex; align-items: center; gap: 0.3rem; }
  .status-item .label { color: var(--text-dim); }

  .my-name-badge {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--accent);
    padding: 0.25rem 0.7rem;
    background: rgba(108, 140, 255, 0.1);
    border: 1px solid rgba(108, 140, 255, 0.3);
    border-radius: 6px;
  }

  .opponents-row {
    display: flex;
    gap: 0.6rem;
    margin-bottom: 0.8rem;
    flex-wrap: wrap;
  }

  .opponent-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.7rem 1.1rem;
    flex: 1;
    min-width: 180px;
    font-size: 0.95rem;
  }

  .opponent-card.is-current {
    border-color: var(--accent);
    box-shadow: 0 0 8px var(--accent-glow);
  }

  .opponent-card .opp-name {
    font-weight: 600;
    margin-bottom: 0.3rem;
  }

  .opponent-card .opp-stats {
    color: var(--text-dim);
    display: flex;
    gap: 0.6rem;
  }

  .opponent-play-area {
    display: flex;
    gap: 0.2rem;
    margin-top: 0.3rem;
    flex-wrap: wrap;
  }

  .mini-card {
    font-size: 0.8rem;
    padding: 0.2rem 0.45rem;
    border-radius: 4px;
    background: var(--surface2);
    border: 1px solid var(--border);
  }

  /* â”€â”€ Supply â”€â”€ */
  .supply-section {
    margin-bottom: 0.8rem;
  }

  .supply-section h3 {
    font-size: 0.95rem;
    color: var(--text-dim);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .supply-layout {
    display: flex;
    gap: clamp(0.5rem, 1vw, 1.5rem);
    align-items: flex-start;
    justify-content: center;
  }

  .supply-victory-cards {
    display: grid;
    grid-template-columns: var(--card-w);
    gap: clamp(0.3rem, 0.5vw, 0.6rem);
    flex-shrink: 0;
  }

  .supply-treasure-cards {
    display: grid;
    grid-template-columns: var(--card-w);
    gap: clamp(0.3rem, 0.5vw, 0.6rem);
    flex-shrink: 0;
  }

  .supply-action-cards {
    display: grid;
    grid-template-columns: repeat(5, var(--card-w));
    gap: clamp(0.3rem, 0.5vw, 0.6rem);
    flex-shrink: 0;
  }

  .supply-card {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: clamp(10px, 1.2vw, 18px);
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    width: var(--card-w);
    min-height: var(--card-h);
    display: flex;
    flex-direction: column;
  }

  .supply-card:hover {
    border-color: var(--accent);
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
  }

  .supply-card.empty {
    opacity: 0.35;
    pointer-events: none;
  }

  /* ã‚«ãƒ¼ãƒ‰ä¸Šéƒ¨ï¼šåå‰ã‚¨ãƒªã‚¢
     ã‚³ã‚¹ãƒˆãƒãƒƒã‚¸ã¯ position:absolute ã§é‡ã­ã‚‹ãŸã‚
     padding ã¯å·¦å³å¯¾ç§°ã«ã—ã¦åå‰ã‚’çœŸã‚“ä¸­æƒãˆã«ã™ã‚‹ */
  .supply-card .card-header {
    position: relative;
    padding: clamp(0.3rem, 0.45vw, 0.55rem) clamp(0.4rem, 0.6vw, 0.7rem);
    flex-shrink: 0;
    border-bottom: 1px solid var(--border);
    text-align: center;
  }

  .supply-card .card-name {
    font-size: clamp(0.72rem, 1vw, 0.95rem);
    font-weight: 700;
    line-height: 1.2;
    /* ã‚³ã‚¹ãƒˆãƒ»æ®‹æ•°ãƒãƒƒã‚¸ã¨é‡ãªã‚‰ãªã„ã‚ˆã†å·¦å³ã«ä½™ç™½ */
    padding: 0 clamp(1.4rem, 1.8vw, 2.2rem);
  }

  /* ã‚³ã‚¹ãƒˆãƒãƒƒã‚¸ï¼šcard-header å†…ã« absolute ã§å³ä¸Šã«é…ç½® */
  .supply-card .card-cost {
    position: absolute;
    top: 50%;
    right: clamp(0.3rem, 0.4vw, 0.5rem);
    transform: translateY(-50%);
    background: var(--sigil);
    color: #000;
    font-size: clamp(0.7rem, 0.88vw, 1rem);
    font-weight: 700;
    width: clamp(18px, 1.7vw, 26px);
    height: clamp(18px, 1.7vw, 26px);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    flex-shrink: 0;
    z-index: 1;
  }

  /* ã‚«ãƒ¼ãƒ‰ä¸­å¤®ï¼šã‚¢ã‚¤ã‚³ãƒ³ã‚¨ãƒªã‚¢ â€” flex:1 ã§ä½™ç™½ã‚’å¸å */
  .supply-card .card-art {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: clamp(1.6rem, 2.4vw, 3.2rem);
    background: rgba(0,0,0,0.18);
    border-bottom: 1px solid var(--border);
    min-height: clamp(44px, 5vw, 80px);
    padding: clamp(0.2rem, 0.4vw, 0.6rem);
    line-height: 1;
  }

  /* ã‚«ãƒ¼ãƒ‰ä¸‹éƒ¨ï¼šèª¬æ˜ãƒ»åŠ¹æœã‚¨ãƒªã‚¢ â€” å†…å®¹åˆ†ã ã‘ç¢ºä¿ã€ä½™ç™½ã¯ card-art ãŒå¸å */
  .supply-card .card-body {
    flex-shrink: 0;
    padding: clamp(0.25rem, 0.4vw, 0.5rem) clamp(0.3rem, 0.5vw, 0.6rem);
    text-align: center;
  }

  .supply-card .card-flavor {
    display: none;
    font-size: clamp(0.52rem, 0.65vw, 0.75rem);
    color: var(--text-dim);
    line-height: 1.3;
    margin-bottom: clamp(0.15rem, 0.25vw, 0.35rem);
    font-style: italic;
  }

  .supply-card .card-effects {
    font-size: clamp(0.7rem, 0.85vw, 0.85rem);
    font-weight: 600;
    line-height: 1.4;
    color: var(--text);
  }

  .supply-card .card-effects .effect-line {
    display: block;
  }

  .supply-card .card-count {
    position: absolute;
    top: 50%;
    left: clamp(0.3rem, 0.4vw, 0.5rem);
    transform: translateY(-50%);
    font-size: clamp(0.55rem, 0.7vw, 0.82rem);
    color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
  }

  .supply-card.type-treasure { background: var(--treasure-bg); }
  .supply-card.type-victory { background: var(--victory-bg); }
  .supply-card.type-action { background: var(--action-bg); }
  .supply-card.subtype-attack { background: #1f1218; border-color: #7a2030; }
  .supply-card.subtype-attack:hover { border-color: #e05070; }
  .supply-card.subtype-reaction { background: #111a2a; border-color: #1a4a7a; }
  .supply-card.subtype-reaction:hover { border-color: #4090d0; }

  /* ã‚µãƒ–ã‚¿ã‚¤ãƒ—ãƒãƒƒã‚¸ */
  .supply-card .card-subtype {
    display: inline-block;
    font-size: clamp(0.55rem, 0.72vw, 0.72rem);
    font-weight: 700;
    letter-spacing: 0.05em;
    padding: 0.1em 0.5em;
    border-radius: 3px;
    margin-top: 0.2em;
    text-transform: uppercase;
  }
  .card-subtype.st-action   { background: rgba(108,140,255,0.25); color: #8aabff; }
  .card-subtype.st-attack   { background: rgba(220, 60, 80,0.3);  color: #f07090; }
  .card-subtype.st-reaction { background: rgba(50, 160,220,0.25); color: #60c0e8; }

  /* â”€â”€ Play Area â”€â”€ */
  .play-area-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.8rem;
    margin-bottom: 0.8rem;
    min-height: 60px;
  }

  .play-area-section h3 {
    font-size: 0.9rem;
    color: var(--text-dim);
    margin-bottom: 0.4rem;
  }

  .play-area-cards {
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
  }

  .played-card {
    padding: 0.4rem 0.8rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  /* â”€â”€ Hand â”€â”€ */
  .hand-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.8rem;
    margin-bottom: 0.8rem;
  }

  .hand-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .hand-header h3 {
    font-size: 0.95rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .hand-cards {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .hand-card {
    background: var(--surface2);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    padding: 0.8rem 1rem;
    cursor: pointer;
    transition: all 0.15s;
    min-width: 120px;
    text-align: center;
    position: relative;
  }

  .hand-card:hover {
    border-color: var(--accent);
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  .hand-card.selected {
    border-color: var(--red);
    background: rgba(248, 113, 113, 0.1);
  }

  .hand-card .card-icon { font-size: 1.8rem; }
  .hand-card .card-name { font-size: 0.85rem; font-weight: 600; margin-top: 0.2rem; }
  .hand-card .card-effects-small { font-size: 0.7rem; color: var(--green); font-weight: 600; margin-top: 0.2rem; line-height: 1.3; }

  .hand-card.type-treasure { border-color: #b8733355; }
  .hand-card.type-treasure:hover { border-color: #b87333; }
  .hand-card.type-victory { border-color: #228b2255; }
  .hand-card.type-action { border-color: #6c8cff55; }
  .hand-card.type-action:hover { border-color: var(--accent); }

  /* â”€â”€ Actions Bar â”€â”€ */
  .actions-bar {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 0.8rem;
  }

  /* â”€â”€ Log â”€â”€ */
  .log-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.8rem;
    max-height: 180px;
    overflow-y: auto;
  }

  .log-section h3 {
    font-size: 0.9rem;
    color: var(--text-dim);
    margin-bottom: 0.4rem;
  }

  .log-entry {
    font-size: 0.9rem;
    color: var(--text-dim);
    padding: 0.2rem 0;
    font-family: 'JetBrains Mono', monospace;
    border-bottom: 1px solid var(--border);
  }

  .log-entry:last-child { border: none; }

  /* â”€â”€ Toast â”€â”€ */
  .toast {
    position: fixed;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--red);
    color: #fff;
    padding: 0.7rem 1.5rem;
    border-radius: var(--radius);
    font-size: 0.85rem;
    font-weight: 600;
    z-index: 100;
    transition: transform 0.3s ease;
    pointer-events: none;
  }

  .toast.show {
    transform: translateX(-50%) translateY(0);
  }

  /* â”€â”€ Game Over Overlay â”€â”€ */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
  }

  .overlay.active { display: flex; }

  .overlay-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 2.5rem;
    text-align: center;
    max-width: 400px;
    width: 90%;
  }

  .overlay-card h2 {
    font-size: 1.4rem;
    margin-bottom: 1rem;
  }

  .score-list {
    list-style: none;
    margin: 1rem 0;
  }

  .score-list li {
    padding: 0.6rem;
    background: var(--surface2);
    border-radius: var(--radius);
    margin-bottom: 0.3rem;
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
  }

  .score-list li:first-child {
    background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(251,191,36,0.05));
    border: 1px solid rgba(251,191,36,0.3);
  }

  .discard-prompt {
    background: rgba(248, 113, 113, 0.1);
    border: 1px solid var(--red);
    border-radius: var(--radius);
    padding: 0.8rem 1rem;
    margin-bottom: 0.8rem;
    font-size: 0.85rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  @media (min-width: 1600px) {
    .supply-card .card-flavor { display: block; }
  }

  @media (max-width: 800px) {
    :root { --card-w: clamp(80px, 13vw, 110px); --card-h: clamp(110px, 18vw, 152px); }
    .supply-layout { flex-direction: column; align-items: center; }
    .supply-victory-cards { grid-template-columns: repeat(auto-fill, var(--card-w)); }
    .supply-treasure-cards { grid-template-columns: repeat(auto-fill, var(--card-w)); }
    .supply-action-cards { grid-template-columns: repeat(auto-fill, var(--card-w)); }
  }

  @media (max-width: 600px) {
    .hand-card { min-width: 75px; padding: 0.4rem 0.5rem; }
  }
</style>
</head>
<body>

<!-- â”€â”€ LOBBY â”€â”€ -->
<div id="lobby">
  <div class="lobby-card">
    <h1>ğŸ‘‘ Sovereign</h1>
    <p class="subtitle">ãƒ‡ãƒƒã‚­æ§‹ç¯‰å‹ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </p>

    <div class="form-group">
      <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
      <input type="text" id="playerName" value="" placeholder="åå‰ã‚’å…¥åŠ›" maxlength="20">
    </div>

    <div class="form-group">
      <label>ãƒ«ãƒ¼ãƒ IDï¼ˆå‚åŠ ã™ã‚‹å ´åˆï¼‰</label>
      <input type="text" id="roomId" value="" placeholder="ç©ºæ¬„ã§æ–°è¦ä½œæˆ">
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" onclick="joinOrCreate()">å‚åŠ  / ä½œæˆ</button>
      <button class="btn btn-secondary" onclick="refreshRooms()">ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’æ›´æ–°</button>
    </div>

    <div class="room-list" id="roomList">
      <h3>å…¬é–‹ãƒ«ãƒ¼ãƒ </h3>
      <div id="roomListItems"><span style="color:var(--text-dim);font-size:0.8rem">èª­ã¿è¾¼ã¿ä¸­...</span></div>
    </div>
  </div>
</div>

<!-- â”€â”€ WAITING ROOM â”€â”€ -->
<div id="waiting">
  <div class="waiting-card">
    <h2>å¾…æ©Ÿä¸­...</h2>
    <div class="room-code" id="waitRoomCode"></div>
    <p style="font-size:0.8rem;color:var(--text-dim)">ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å‹äººã«å…±æœ‰ã—ã¦ãã ã•ã„</p>
    <ul class="player-list" id="waitPlayerList"></ul>
    <div class="btn-row" style="justify-content:center">
      <button class="btn btn-primary" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
    </div>
  </div>
</div>

<!-- â”€â”€ GAME BOARD â”€â”€ -->
<div id="game">
  <div class="game-header">
    <div class="turn-info">
      <span id="turnPlayer"></span>
      <span class="phase-badge" id="phaseBadge"></span>
    </div>
    <div class="status-bar" id="statusBar"></div>
    <div class="my-name-badge" id="myNameBadge"></div>
  </div>

  <div class="opponents-row" id="opponents"></div>

  <div id="discardPrompt" class="discard-prompt" style="display:none">
    <span id="discardPromptText"></span>
    <button class="btn btn-small btn-red" onclick="submitDiscard()">æ±ºå®š</button>
  </div>

  <div class="supply-section">
    <h3>ã‚µãƒ—ãƒ©ã‚¤</h3>
    <div class="supply-layout">
      <div class="supply-victory-cards" id="supplyVictoryGrid"></div>
      <div class="supply-treasure-cards" id="supplyTreasureGrid"></div>
      <div class="supply-action-cards" id="supplyActionGrid"></div>
    </div>
  </div>

  <div class="play-area-section">
    <h3>å ´ã«å‡ºã—ãŸã‚«ãƒ¼ãƒ‰</h3>
    <div class="play-area-cards" id="playArea"></div>
  </div>

  <div class="hand-section">
    <div class="hand-header">
      <h3>æ‰‹æœ­</h3>
      <div class="actions-bar" id="actionsBar"></div>
    </div>
    <div class="hand-cards" id="handCards"></div>
  </div>

  <div class="log-section">
    <h3>ãƒ­ã‚°</h3>
    <div id="logEntries"></div>
  </div>
</div>

<!-- â”€â”€ Game Over Overlay â”€â”€ -->
<div class="overlay" id="gameOverOverlay">
  <div class="overlay-card">
    <h2>ğŸ† ã‚²ãƒ¼ãƒ çµ‚äº†</h2>
    <ul class="score-list" id="scoreList"></ul>
    <button class="btn btn-primary" onclick="location.reload()">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
  </div>
</div>

<!-- â”€â”€ Toast â”€â”€ -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ws = null;
let playerId = null;
let gameId = null;
let cardDefs = {};
let gameState = null;
let selectedDiscards = new Set();
let discardMode = false;
let trashMode = false;
let topdeckMode = false;

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

const effectLabels = {
  draw:              n => `+${n} ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã`,
  action:            n => `+${n} ã‚¢ã‚¯ã‚·ãƒ§ãƒ³`,
  buy:               n => `+${n} è³¼å…¥`,
  coin:              n => `+${n} ã‚³ã‚¤ãƒ³`,
  coin_value:        n => `+${n} ã‚³ã‚¤ãƒ³`,
  victory_points:    n => `${n} å‹åˆ©ç‚¹`,
  attack_discard_to: n => `ã€æ”»æ’ƒã€‘ä»–è€…ã¯æ‰‹æœ­${n}æšã¾ã§æ¨ã¦ã‚‹`,
  discard_draw:      _ => `å¥½ããªæšæ•°ã‚’æ¨ã¦ã€åŒæ•°å¼•ã`,
  gain_card_up_to:   n => `ã‚³ã‚¹ãƒˆ${n}ä»¥ä¸‹ã‚’ç²å¾—`,
  trash:                         n => `æ‰‹æœ­${n}æšã¾ã§å»ƒæ£„`,
  trash_and_gain:                n => `1æšå»ƒæ£„â†’ã‚³ã‚¹ãƒˆ+${n}ä»¥ä¸‹ã‚’ç²å¾—`,
  trash_treasure_gain_treasure:  n => `è²¡å®å»ƒæ£„â†’ã‚³ã‚¹ãƒˆ+${n}ä»¥ä¸‹ã®è²¡å®ã‚’æ‰‹æœ­ã«`,
  trash_copper_for_coin:         n => `æœ€å®‰è²¡å®ã‚’å»ƒæ£„ã§+${n}ã‚³ã‚¤ãƒ³`,
  opponents_draw:                n => `ä»–è€…: +${n} ãƒ‰ãƒ­ãƒ¼`,
  gain_card_to_hand:             n => `ã‚³ã‚¹ãƒˆ${n}ä»¥ä¸‹ã‚’æ‰‹æœ­ã«ç²å¾—, æ‰‹æœ­1æšã‚’ãƒ‡ãƒƒã‚­ãƒˆãƒƒãƒ—ã«`,
  topdeck_from_discard:          _ => `æ¨ã¦æœ­1æšã‚’ãƒ‡ãƒƒã‚­ãƒˆãƒƒãƒ—ã«`,
  discard_top_play_action:       _ => `ãƒ‡ãƒƒã‚­ãƒˆãƒƒãƒ—1æšã‚’æ¨ã¦æœ­ã«ã€‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãªã‚‰ãƒ—ãƒ¬ã‚¤å¯`,
  gain_treasure_topdeck_attack_victory: n => `ã‚³ã‚¹ãƒˆ${n}ã®è²¡å®ã‚’ãƒ‡ãƒƒã‚­ãƒˆãƒƒãƒ—ã«ç²å¾—,ã€æ”»æ’ƒã€‘ä»–è€…ã¯å‹åˆ©ç‚¹ã‚’ãƒ‡ãƒƒã‚­ãƒˆãƒƒãƒ—ã«`,
  reveal_trash_discard_topdeck:  n => `ãƒ‡ãƒƒã‚­ãƒˆãƒƒãƒ—${n}æšã‚’å…¬é–‹ã—ã€å„ã€…å»ƒæ£„/æ¨ã¦/æˆ»ã™`,
};

function buildEffectLines(c) {
  let effects = c.effects || [];
  if (effects.length === 0) {
    if (c.type === 'treasure' && c.coin_value != null)
      effects = [{ type: 'coin_value', amount: c.coin_value }];
    else if (c.type === 'victory' && c.victory_points != null)
      effects = [{ type: 'victory_points', amount: c.victory_points }];
  }
  const lines = effects.map(ef => {
    const fn = effectLabels[ef.type];
    return fn ? fn(ef.amount) : null;
  }).filter(Boolean);
  if (c.reaction === 'block_attack') lines.push('æ”»æ’ƒã‚’ç„¡åŠ¹åŒ–');
  return lines;
}

// â”€â”€ Card Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCardData() {
  const res = await fetch('/api/cards');
  const data = await res.json();
  for (const card of data.cards || []) {
    cardDefs[card.id] = card;
  }
}

function getCard(id) {
  return cardDefs[id] || { id, name: id, icon: '?', description: '', type: 'unknown', cost: 0 };
}

// â”€â”€ Lobby â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshRooms() {
  const res = await fetch('/api/games');
  const rooms = await res.json();
  const el = document.getElementById('roomListItems');
  if (rooms.length === 0) {
    el.innerHTML = '<span style="color:var(--text-dim);font-size:0.8rem">ãƒ«ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</span>';
    return;
  }
  el.innerHTML = rooms.map(r => `
    <div class="room-item">
      <span><span class="room-id">${r.game_id}</span> (${r.players.length}äºº${r.started ? ' - é€²è¡Œä¸­' : ''})</span>
      ${!r.started ? `<button class="btn btn-small btn-primary" onclick="joinRoom('${r.game_id}')">å‚åŠ </button>` : ''}
    </div>
  `).join('');
}

function joinRoom(rid) {
  document.getElementById('roomId').value = rid;
  joinOrCreate();
}

async function joinOrCreate() {
  const name = document.getElementById('playerName').value.trim() || 'Player';
  let rid = document.getElementById('roomId').value.trim();

  if (!rid) {
    const res = await fetch('/api/games', { method: 'POST' });
    const data = await res.json();
    rid = data.game_id;
  }

  gameId = rid;
  connectWS(name);
}

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectWS(name) {
  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${protocol}//${location.host}/ws/${gameId}`);

  ws.onopen = () => {
    const savedId = sessionStorage.getItem(`pid_${gameId}`);
    ws.send(JSON.stringify({
      action: 'join',
      name: name,
      player_id: savedId || undefined,
    }));
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);

    if (msg.type === 'joined') {
      playerId = msg.player_id;
      sessionStorage.setItem(`pid_${gameId}`, playerId);
    } else if (msg.type === 'state') {
      gameState = msg.state;
      render();
    } else if (msg.type === 'error') {
      showToast(msg.message);
    }
  };

  ws.onclose = () => {
    showToast('æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
  };
}

function send(data) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(data));
  }
}

function startGame() {
  send({ action: 'start' });
}

// â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  if (!gameState) return;

  if (!gameState.started) {
    showWaiting();
    return;
  }

  if (gameState.phase === 'game_over') {
    showGame();
    showGameOver();
    return;
  }

  showGame();
}

function showWaiting() {
  document.getElementById('lobby').style.display = 'none';
  document.getElementById('waiting').style.display = 'flex';
  document.getElementById('game').style.display = 'none';

  document.getElementById('waitRoomCode').textContent = gameState.game_id;

  const list = document.getElementById('waitPlayerList');
  list.innerHTML = gameState.players.map(p =>
    `<li>${esc(p.name)}${p.id === playerId ? ' (ã‚ãªãŸ)' : ''}</li>`
  ).join('');
}

function showGame() {
  document.getElementById('lobby').style.display = 'none';
  document.getElementById('waiting').style.display = 'none';
  document.getElementById('game').style.display = 'block';

  const st = gameState;
  const myTurn = st.current_player === playerId;
  const me = st.players.find(p => p.id === playerId);

  // Header
  const pa = st.pending_action;
  const isMilitiaTarget = pa?.type === 'attack_discard' && pa?.target_player_id === playerId;
  const isCellarOwner = pa?.type === 'discard_draw' && pa?.player_id === playerId;

  const isMilitiaAttacker = pa?.type === 'attack_discard' && pa?.attacker_id === playerId;

  let turnText, phaseText;
  if (isMilitiaTarget) {
    const attackerName = esc(st.players.find(p => p.id === pa.attacker_id)?.name || 'ç›¸æ‰‹');
    turnText = `${attackerName} ã®ã‚¢ã‚¿ãƒƒã‚¯`;
    phaseText = 'ã‚ãªãŸãŒæ¨ã¦æœ­ã‚’é¸æŠä¸­';
  } else if (isMilitiaAttacker) {
    const targetName = esc(st.players.find(p => p.id === pa.target_player_id)?.name || 'ç›¸æ‰‹');
    turnText = 'ã‚ãªãŸ ã®ã‚¿ãƒ¼ãƒ³';
    phaseText = `${targetName} ãŒæ¨ã¦æœ­ã‚’é¸æŠä¸­`;
  } else if (pa?.type === 'attack_discard') {
    const attackerName = esc(st.players.find(p => p.id === pa.attacker_id)?.name || '?');
    const targetName = esc(st.players.find(p => p.id === pa.target_player_id)?.name || '?');
    turnText = `${attackerName} ã®ã‚¿ãƒ¼ãƒ³`;
    phaseText = `${targetName} ãŒæ¨ã¦æœ­ã‚’é¸æŠä¸­`;
  } else if (isCellarOwner) {
    turnText = myTurn ? 'ã‚ãªãŸ ã®ã‚¿ãƒ¼ãƒ³' : `${esc(st.current_player_name)} ã®ã‚¿ãƒ¼ãƒ³`;
    phaseText = 'æ¨ã¦æœ­é¸æŠ';
  } else {
    const turnName = myTurn ? 'ã‚ãªãŸ' : esc(st.current_player_name);
    turnText = `${turnName} ã®ã‚¿ãƒ¼ãƒ³`;
    const phaseLabels = {
      action: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³', buy: 'è³¼å…¥', cleanup: 'ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—',
      discard: 'æ¨ã¦æœ­é¸æŠ', gain: 'ç²å¾—é¸æŠ', discard_draw: 'æ¨ã¦æœ­é¸æŠ',
      trash: 'å»ƒæ£„é¸æŠ', topdeck: 'ãƒ‡ãƒƒã‚­ãƒˆãƒƒãƒ—é¸æŠ', game_over: 'çµ‚äº†'
    };
    phaseText = phaseLabels[st.phase] || st.phase;
  }

  document.getElementById('turnPlayer').textContent = turnText;
  const badge = document.getElementById('phaseBadge');
  badge.textContent = phaseText;

  // My name badge
  if (me) {
    document.getElementById('myNameBadge').textContent = me.name;
  }

  // Status
  if (me) {
    document.getElementById('statusBar').innerHTML = `
      <div class="status-item"><span class="label">âš¡</span> ${me.actions}</div>
      <div class="status-item"><span class="label">ğŸ›’</span> ${me.buys}</div>
      <div class="status-item"><span class="label">ğŸ’°</span> ${me.coins}</div>
      <div class="status-item"><span class="label">ğŸ“š</span> ${me.deck_count}</div>
      <div class="status-item"><span class="label">ğŸ—‘ï¸</span> ${me.discard_count}</div>
    `;
  }

  // Opponents
  const opps = st.players.filter(p => p.id !== playerId);
  document.getElementById('opponents').innerHTML = opps.map(p => `
    <div class="opponent-card ${p.id === st.current_player ? 'is-current' : ''}">
      <div class="opp-name">${esc(p.name)}${!p.connected ? ' (åˆ‡æ–­)' : ''}</div>
      <div class="opp-stats">
        <span>æ‰‹æœ­:${p.hand_count}</span>
        <span>å±±:${p.deck_count}</span>
        <span>æ¨:${p.discard_count}</span>
      </div>
      <div class="opponent-play-area">
        ${(p.play_area || []).map(cid => {
          const c = getCard(cid);
          return `<span class="mini-card">${c.icon || ''} ${c.name}</span>`;
        }).join('')}
      </div>
    </div>
  `).join('');

  // Discard / Trash prompt
  const dp = document.getElementById('discardPrompt');
  discardMode = false;
  trashMode = false;
  topdeckMode = false;

  if (pa && pa.type === 'attack_discard' && pa.target_player_id === playerId) {
    dp.style.display = 'flex';
    const needed = (me?.hand?.length || 0) - (pa.discard_to ?? 0);
    document.getElementById('discardPromptText').textContent =
      `ã‚¢ã‚¿ãƒƒã‚¯ï¼ ${needed}æšé¸ã‚“ã§æ¨ã¦ã¦ãã ã•ã„ï¼ˆæ‰‹æœ­ã‚’${pa.discard_to}æšã«ï¼‰`;
    discardMode = true;
  } else if (pa && pa.type === 'discard_draw' && pa.player_id === playerId) {
    dp.style.display = 'flex';
    document.getElementById('discardPromptText').textContent =
      'æ¨ã¦ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆ0æšã§ã‚‚OKï¼‰';
    discardMode = true;
  } else if (pa && pa.type === 'trash' && pa.player_id === playerId) {
    dp.style.display = 'flex';
    document.getElementById('discardPromptText').textContent =
      `å»ƒæ£„ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆ${pa.max_cards}æšã¾ã§ã€0æšOKï¼‰`;
    discardMode = true;
    trashMode = true;
  } else if (pa && pa.type === 'trash_and_gain' && pa.player_id === playerId) {
    dp.style.display = 'flex';
    document.getElementById('discardPromptText').textContent =
      'å»ƒæ£„ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’1æšé¸ã‚“ã§ãã ã•ã„';
    discardMode = true;
    trashMode = true;
  } else if (pa && pa.type === 'trash_treasure_gain_treasure' && pa.player_id === playerId) {
    dp.style.display = 'flex';
    document.getElementById('discardPromptText').textContent =
      'å»ƒæ£„ã™ã‚‹è²¡å®ã‚«ãƒ¼ãƒ‰ã‚’1æšé¸ã‚“ã§ãã ã•ã„';
    discardMode = true;
    trashMode = true;
  } else if (pa && pa.type === 'topdeck_from_hand' && pa.player_id === playerId) {
    dp.style.display = 'flex';
    document.getElementById('discardPromptText').textContent =
      'ãƒ‡ãƒƒã‚­ãƒˆãƒƒãƒ—ã«ç½®ãã‚«ãƒ¼ãƒ‰ã‚’1æšé¸ã‚“ã§ãã ã•ã„';
    discardMode = true;
    topdeckMode = true;
  } else if (pa && pa.type === 'topdeck_from_discard' && pa.player_id === playerId) {
    // Show discard pile selection UI
    const me2 = st.players.find(p => p.id === playerId);
    const discardPile = me2?.discard_pile || [];
    if (discardPile.length > 0) {
      dp.style.display = 'flex';
      document.getElementById('discardPromptText').innerHTML =
        'ãƒ‡ãƒƒã‚­ãƒˆãƒƒãƒ—ã«ç½®ãã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆã‚¹ã‚­ãƒƒãƒ—å¯ï¼‰<br>' +
        discardPile.map(cid => {
          const c = getCard(cid);
          return `<span class="played-card" style="cursor:pointer;margin:2px;padding:2px 6px;border:1px solid var(--border);border-radius:4px" onclick="topdeckFromDiscard('${cid}')">${c.icon || ''} ${c.name} (${c.cost})</span>`;
        }).join('') +
        '<br><button class="btn btn-small" onclick="topdeckFromDiscard(null)" style="margin-top:4px">ã‚¹ã‚­ãƒƒãƒ—</button>';
    } else {
      dp.style.display = 'none';
    }
  } else if (pa && pa.type === 'play_revealed_action' && pa.player_id === playerId) {
    const vc = getCard(pa.revealed_card);
    dp.style.display = 'flex';
    document.getElementById('discardPromptText').innerHTML =
      `${vc.icon || ''} ${vc.name} ã‚’ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã‹ï¼Ÿ ` +
      `<button class="btn btn-small" onclick="vassalDecision(true)" style="margin-left:8px">ãƒ—ãƒ¬ã‚¤ã™ã‚‹</button>` +
      `<button class="btn btn-small btn-red" onclick="vassalDecision(false)" style="margin-left:4px">ã—ãªã„</button>`;
  } else if (pa && pa.type === 'reveal_trash_discard_topdeck' && pa.player_id === playerId) {
    const cards = pa.revealed_cards || [];
    dp.style.display = 'flex';
    window.sentryDecisions = {};
    document.getElementById('discardPromptText').innerHTML =
      'å„ã‚«ãƒ¼ãƒ‰ã®å‡¦ç†ã‚’é¸ã‚“ã§ãã ã•ã„ï¼š<br>' +
      cards.map((cid, i) => {
        const c = getCard(cid);
        return `<div style="margin:4px 0;display:flex;align-items:center;gap:4px" id="sentry-row-${i}">` +
          `<span>${c.icon || ''} ${c.name} (${c.cost})</span>` +
          `<button class="btn btn-small btn-red" onclick="sentryAction(${i},'trash')">å»ƒæ£„</button>` +
          `<button class="btn btn-small" onclick="sentryAction(${i},'discard')">æ¨ã¦</button>` +
          `<button class="btn btn-small" onclick="sentryAction(${i},'topdeck')">æˆ»ã™</button>` +
          `</div>`;
      }).join('');
  } else {
    dp.style.display = 'none';
    selectedDiscards.clear();
  }

  // Supply
  renderSupply(st, myTurn, me);

  // Play area
  const pa2 = document.getElementById('playArea');
  if (me) {
    pa2.innerHTML = (me.play_area || []).map(cid => {
      const c = getCard(cid);
      return `<span class="played-card">${c.icon || ''} ${c.name}</span>`;
    }).join('') || '<span style="color:var(--text-dim);font-size:0.75rem">ãªã—</span>';
  }

  // Hand
  renderHand(me, myTurn, st);

  // Actions bar
  renderActions(myTurn, st, me);

  // Log
  renderLog(st.log);
}

function renderSupply(st, myTurn, me) {
  const victoryGrid = document.getElementById('supplyVictoryGrid');
  const treasureGrid = document.getElementById('supplyTreasureGrid');
  const actionGrid = document.getElementById('supplyActionGrid');
  const entries = Object.entries(st.supply || {});

  // Check if we're in gain mode
  const gainType = st.pending_action?.type;
  const isGainMode = (gainType === 'gain' || gainType === 'gain_to_hand' || gainType === 'gain_treasure_to_hand')
    && st.pending_action?.player_id === playerId;
  const maxCost = st.pending_action?.max_cost || 0;

  function makeCardHTML(cid, count) {
    const c = getCard(cid);
    const canBuy = myTurn && st.phase === 'buy' && (me?.coins || 0) >= (c.cost || 0) && count > 0 && (me?.buys || 0) > 0;
    const canGain = isGainMode && count > 0 && (c.cost || 0) <= maxCost
      && (gainType !== 'gain_treasure_to_hand' || c.type === 'treasure');

    let onclick = '';
    if (canGain) {
      onclick = `onclick="gainCard('${cid}')"`;
    } else if (canBuy) {
      onclick = `onclick="buyCard('${cid}')"`;
    }

    const lines = buildEffectLines(c);
    const effectLines = lines.map(l => `<span class="effect-line">${l}</span>`).join('');

    // ãƒ•ãƒ¬ãƒ¼ãƒãƒ¼ãƒ†ã‚­ã‚¹ãƒˆï¼ˆdescription ã¯ãƒ•ãƒ¬ãƒ¼ãƒãƒ¼ã®ã¿ï¼‰
    const flavorText = c.description || '';

    // åŠ¹æœã¯ effects é…åˆ—ã‹ã‚‰ç”Ÿæˆã€ãƒ•ãƒ¬ãƒ¼ãƒãƒ¼ã¯CSSåˆ¶å¾¡ã§å¤§ç”»é¢ã®ã¿
    const bodyHTML = effectLines
      ? `${flavorText ? `<div class="card-flavor">${flavorText}</div>` : ''}<div class="card-effects">${effectLines}</div>`
      : (flavorText ? `<div class="card-flavor" style="display:block">${flavorText}</div>` : '');

    const subtype = c.subtype || (c.type === 'action' ? 'action' : '');
    const subtypeLabels = { action: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³', attack: 'ã‚¢ã‚¿ãƒƒã‚¯', reaction: 'ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³' };
    const subtypeBadge = subtype && subtypeLabels[subtype]
      ? `<div class="card-subtype st-${subtype}">${subtypeLabels[subtype]}</div>`
      : '';

    return `
      <div class="supply-card type-${c.type} subtype-${subtype} ${count <= 0 ? 'empty' : ''}" ${onclick}
           style="${(canBuy || canGain) ? 'cursor:pointer' : 'cursor:default'}">
        <div class="card-header">
          <div class="card-count">Ã—${count}</div>
          <div class="card-name">${c.name}</div>
          ${subtypeBadge}
          <div class="card-cost">${c.cost ?? 0}</div>
        </div>
        <div class="card-art">${c.icon || 'ğŸƒ'}</div>
        <div class="card-body">
          ${bodyHTML}
        </div>
      </div>
    `;
  }

  // Split into victory, treasure, action
  const victoryEntries = [];
  const treasureEntries = [];
  const actionEntries = [];
  for (const [cid, count] of entries) {
    const c = getCard(cid);
    if (c.type === 'victory') victoryEntries.push([cid, count]);
    else if (c.type === 'treasure') treasureEntries.push([cid, count]);
    else actionEntries.push([cid, count]);
  }

  // Sort victory/treasure by cost desc, actions by cost asc
  victoryEntries.sort((a, b) => (getCard(b[0]).cost || 0) - (getCard(a[0]).cost || 0));
  treasureEntries.sort((a, b) => (getCard(b[0]).cost || 0) - (getCard(a[0]).cost || 0));
  actionEntries.sort((a, b) => (getCard(a[0]).cost || 0) - (getCard(b[0]).cost || 0));

  victoryGrid.innerHTML = victoryEntries.map(([cid, count]) => makeCardHTML(cid, count)).join('');
  treasureGrid.innerHTML = treasureEntries.map(([cid, count]) => makeCardHTML(cid, count)).join('');
  actionGrid.innerHTML = actionEntries.map(([cid, count]) => makeCardHTML(cid, count)).join('');
}

function renderHand(me, myTurn, st) {
  const container = document.getElementById('handCards');
  if (!me || !me.hand) {
    container.innerHTML = '';
    return;
  }

  container.innerHTML = me.hand.map((cid, idx) => {
    const c = getCard(cid);
    const isSelected = selectedDiscards.has(idx);

    let onclick = '';
    if (discardMode) {
      onclick = `onclick="toggleDiscard(${idx})"`;
    } else if (myTurn && c.type === 'action' && st.phase === 'action' && (me.actions || 0) > 0) {
      onclick = `onclick="playAction('${cid}')"`;
    } else if (myTurn && c.type === 'treasure' && (st.phase === 'action' || st.phase === 'buy')) {
      onclick = `onclick="playTreasure('${cid}')"`;
    }

    const handEffects = buildEffectLines(c).join(' / ');
    return `
      <div class="hand-card type-${c.type} ${isSelected ? 'selected' : ''}" ${onclick}>
        <div class="card-icon">${c.icon || 'ğŸƒ'}</div>
        <div class="card-name">${c.name}</div>
        ${handEffects ? `<div class="card-effects-small">${handEffects}</div>` : ''}
      </div>
    `;
  }).join('');
}

function renderActions(myTurn, st, me) {
  const bar = document.getElementById('actionsBar');
  if (!myTurn) {
    bar.innerHTML = '';
    return;
  }

  let buttons = [];

  if (st.phase === 'action') {
    buttons.push(`<button class="btn btn-small btn-secondary" onclick="skipAction()">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†</button>`);
  }

  if (st.phase === 'action' || st.phase === 'buy') {
    buttons.push(`<button class="btn btn-small btn-sigil" onclick="playAllTreasures()">ğŸ’° å…¨è²¡å®ã‚’å‡ºã™</button>`);
  }

  if (st.phase === 'buy' || st.phase === 'action') {
    buttons.push(`<button class="btn btn-small btn-secondary" onclick="endTurn()">ã‚¿ãƒ¼ãƒ³çµ‚äº†</button>`);
  }

  bar.innerHTML = buttons.join('');
}

function renderLog(log) {
  const el = document.getElementById('logEntries');
  el.innerHTML = (log || []).slice().reverse().map(l =>
    `<div class="log-entry">${l}</div>`
  ).join('');
}

function showGameOver() {
  const overlay = document.getElementById('gameOverOverlay');
  overlay.classList.add('active');

  const scores = gameState.scores || [];
  scores.sort((a, b) => b.vp - a.vp);

  document.getElementById('scoreList').innerHTML = scores.map((s, i) => `
    <li>
      <span>${i === 0 ? 'ğŸ‘‘ ' : ''}${esc(s.name)}${s.id === playerId ? ' (ã‚ãªãŸ)' : ''}</span>
      <span>${s.vp} VP</span>
    </li>
  `).join('');
}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playAction(cardId) { send({ action: 'play_action', card_id: cardId }); }
function playTreasure(cardId) { send({ action: 'play_treasure', card_id: cardId }); }
function playAllTreasures() { send({ action: 'play_all_treasures' }); }
function skipAction() { send({ action: 'skip_action' }); }
function endTurn() { send({ action: 'end_turn' }); }
function buyCard(cardId) { send({ action: 'buy', card_id: cardId }); }
function gainCard(cardId) { send({ action: 'gain_selection', card_id: cardId }); }

function toggleDiscard(idx) {
  if (selectedDiscards.has(idx)) {
    selectedDiscards.delete(idx);
  } else {
    selectedDiscards.add(idx);
  }
  // Re-render hand with updated selections
  const me = gameState.players.find(p => p.id === playerId);
  renderHand(me, true, gameState);
}

function submitDiscard() {
  const me = gameState.players.find(p => p.id === playerId);
  if (!me) return;

  const cardIds = Array.from(selectedDiscards).map(idx => me.hand[idx]);
  const pa = gameState.pending_action;

  if (topdeckMode) {
    // topdeck_from_hand: send the first selected card
    send({ action: 'topdeck_selection', card_id: cardIds[0] || null });
  } else if (pa?.type === 'attack_discard' || pa?.type === 'discard_draw') {
    send({ action: 'discard_selection', card_ids: cardIds });
  } else if (trashMode) {
    send({ action: 'trash_selection', card_ids: cardIds });
  }
  selectedDiscards.clear();
}

function topdeckFromDiscard(cardId) {
  send({ action: 'topdeck_selection', card_id: cardId });
}

function vassalDecision(play) {
  send({ action: 'vassal_decision', play: play });
}

// Sentry: collect decisions per card index, then send all at once
function sentryAction(idx, action) {
  if (!window.sentryDecisions) window.sentryDecisions = {};
  window.sentryDecisions[idx] = action;

  const pa = gameState.pending_action;
  const revealed = pa?.revealed_cards || [];

  // Highlight the decided button
  const row = document.getElementById(`sentry-row-${idx}`);
  if (row) {
    row.querySelectorAll('button').forEach(btn => {
      const onclick = btn.getAttribute('onclick') || '';
      const isMatch = onclick.includes(`'${action}'`);
      btn.style.opacity = isMatch ? '1' : '0.4';
      if (isMatch) btn.style.border = '2px solid var(--accent)';
      else btn.style.border = '';
    });
  }

  // Check if all revealed cards have decisions
  const allDecided = revealed.every((_, i) => window.sentryDecisions[i] != null);
  if (allDecided) {
    const decisions = revealed.map((cid, i) => ({
      card_id: cid,
      action: window.sentryDecisions[i]
    }));
    window.sentryDecisions = {};
    send({ action: 'sentry_decision', decisions: decisions });
  }
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(message) {
  const el = document.getElementById('toast');
  el.textContent = message;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  await loadCardData();
  refreshRooms();

  // Generate random default name
  const adjectives = ['å‹‡æ•¢ãª', 'è³¢ã„', 'ç´ æ—©ã„', 'åŠ›å¼·ã„', 'ä¸æ€è­°ãª'];
  const nouns = ['é¨å£«', 'é­”è¡“å¸«', 'å•†äºº', 'å†’é™ºè€…', 'éŒ¬é‡‘è¡“å¸«'];
  const a = adjectives[Math.floor(Math.random() * adjectives.length)];
  const n = nouns[Math.floor(Math.random() * nouns.length)];
  document.getElementById('playerName').value = a + n;
})();
</script>
</body>
</html>
